# DriftNet - Децентрализованная P2P файловая сеть

## 📋 Обзор системы

DriftNet - это децентрализованная P2P сеть для хранения и передачи файлов, где файлы разбиваются на чанки и циркулируют между узлами без постоянного хранения на диске.

### 🏗️ Архитектура

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Client    │    │ Coordinator │    │    Node 1   │
│             │    │             │    │             │
│ Upload/Get  │◄──►│   Routing   │◄──►│   Chunk     │
│             │    │             │    │  Forwarding │
└─────────────┘    └─────────────┘    └─────────────┘
                           │                   │
                           ▼                   ▼
                    ┌─────────────┐    ┌─────────────┐
                    │    Node 2   │    │    Node 3   │
                    │             │    │             │
                    │   Chunk     │    │   Chunk     │
                    │  Forwarding │    │  Forwarding │
                    └─────────────┘    └─────────────┘
                           │                   │
                           ▼                   ▼
                    ┌─────────────┐    ┌─────────────┐
                    │    ...      │    │   Node 20   │
                    │             │    │             │
                    │   Chunk     │    │   Chunk     │
                    │  Forwarding │    │  Forwarding │
                    └─────────────┘    └─────────────┘
```

## 🚀 Запуск системы

### Предварительные требования
- Docker и Docker Compose
- .NET 8.0 SDK (для разработки)

### Быстрый старт
```bash
# Клонирование и запуск
git clone <repository>
cd DriftNet
docker compose up --build
```

## 📦 Компоненты системы

### 1. **DriftCoordinator** - Центральный координатор
**Назначение:** Управляет регистрацией узлов и маршрутизацией чанков

**Порт:** 8000

**Функции:**
- Регистрация узлов сети
- Предоставление списка активных узлов
- Координация маршрутизации чанков

**API Endpoints:**
- `GET /peers` - получить список всех узлов
- `POST /register` - регистрация нового узла

**Логи:**
```
[REGISTER] New peer: node-1 (172.19.0.5:5001)
[ROUTING] Chunk chunk-0001 → node-3, node-7, node-15
```

### 2. **DriftNode** - Узлы сети (20 экземпляров)
**Назначение:** Обработка и пересылка чанков между узлами

**Порты:** 5001-5020 (по одному на узел)

**Функции:**
- Прием чанков от клиента и других узлов
- Пересылка чанков другим узлам согласно TTL
- Режим восстановления для накопления чанков
- Никогда не хранит чанки на диске (кроме режима восстановления)

**Режимы работы:**
- **Нормальный режим:** Чанки пересылаются и не сохраняются
- **Режим восстановления:** Чанки накапливаются в памяти для восстановления

**Логи:**
```
[RECEIVED] chunk-0001 from 172.19.0.2 (TTL: 10000)
[FORWARD] chunk-0001 → node-5 (TTL: 9999)
[RECOVERY] Mode enabled - accumulating chunks
[FOUND] chunk-0001 in memory (256000 bytes)
```

### 3. **DriftClient** - Клиентское приложение
**Назначение:** Загрузка и восстановление файлов

**Функции:**
- Разбивка файлов на чанки
- Отправка чанков на случайные узлы
- Восстановление файлов из сети

**Интерактивные команды:**
```
> help                    - показать справку
> upload <file-path>      - загрузить файл
> get <chunk-prefix>      - восстановить файл
> exit                    - выйти
```

## 🔄 Процесс работы

### Загрузка файла

1. **Разбивка файла:**
   ```
   Файл (26.7 МБ) → 105 чанков по 256 КБ
   ```

2. **Отправка чанков:**
   ```
   Каждый чанк → 3 случайных узла
   chunk-0001 → node-3, node-7, node-15
   chunk-0002 → node-1, node-12, node-19
   ...
   ```

3. **Циркуляция чанков:**
   ```
   Узлы пересылают чанки друг другу
   TTL уменьшается при каждой пересылке
   Чанки никогда не сохраняются на диске
   ```

### Восстановление файла

1. **Включение режима восстановления:**
   ```
   Все узлы перестают пересылать чанки
   Начинают накапливать их в памяти
   ```

2. **Сбор чанков:**
   ```
   Клиент опрашивает все узлы
   Собирает найденные чанки
   ```

3. **Восстановление файла:**
   ```
   Чанки собираются в правильном порядке
   Файл сохраняется локально
   Режим восстановления отключается
   ```

## ⚙️ Конфигурация

### Переменные окружения

**DriftCoordinator:**
```yaml
# Порт координатора
PORT=8000
```

**DriftNode:**
```yaml
# ID узла
NODE_ID=node-1
# Порт узла
PORT=5001
# URL координатора
COORDINATOR_URL=http://coordinator:8000
```

**DriftClient:**
```yaml
# URL координатора
COORDINATOR_URL=http://coordinator:8000
# Размер чанка (байт)
CHUNK_SIZE=256000
# Время жизни чанка (количество пересылок)
TTL=10000
```

## 🐳 Docker Compose

### Структура сервисов
```yaml
services:
  coordinator:     # Центральный координатор
  node1-node20:    # 20 узлов сети
  drift-client:    # Клиентское приложение
```

### Запуск
```bash
# Полный запуск всех сервисов
docker compose up --build

# Запуск в фоновом режиме
docker compose up -d

# Остановка
docker compose down
```

## 📝 Примеры использования

### 1. Загрузка файла
```bash
# Подключение к клиенту
docker exec -it drift-client dotnet DriftClient.dll

# В интерактивном режиме:
> upload testfile.txt
[UPLOAD] Starting upload of testfile.txt
[INFO] File size: 26747711 bytes
[INFO] Total chunks: 105
[PEERS] Found 20 peers - will use 3 random peers each
[UPLOAD] chunk-0001 (256000 bytes)
[UPLOAD] chunk-0001 → 172.19.0.3:5003
[UPLOAD] chunk-0001 → 172.19.0.7:5007
[UPLOAD] chunk-0001 → 172.19.0.15:5015
...
[SENT] All 105 chunks to 3 random peers each
[UPLOAD] Upload completed successfully
```

### 2. Восстановление файла
```bash
# В том же клиенте:
> get chunk- --out recovered_file.txt
[GET] Starting recovery with prefix: chunk-
[PEERS] Found 20 peers
[RECOVERY] Enabling recovery mode on all nodes...
[WAIT] Waiting 5 seconds for chunks to be intercepted...
[FOUND] chunk-0001 from 172.19.0.12:5019 (256000 bytes)
[FOUND] chunk-0002 from 172.19.0.12:5019 (256000 bytes)
...
[DONE] Output saved to recovered_file.txt
[INFO] Recovered 105 chunks, total size: 26747711 bytes
```

### 3. Мониторинг логов
```bash
# Все логи
docker compose logs -f

# Логи конкретного сервиса
docker compose logs -f coordinator
docker compose logs -f node1
docker compose logs -f drift-client
```

## 🔧 Отладка и мониторинг

### Проверка состояния узлов
```bash
# Проверка координатора
curl http://localhost:8000/peers

# Проверка конкретного узла
docker exec -it node1 dotnet DriftNode.dll
```

### Анализ логов
```bash
# Поиск ошибок
docker compose logs | grep ERROR

# Мониторинг циркуляции чанков
docker compose logs | grep FORWARD

# Проверка регистрации узлов
docker compose logs | grep REGISTER
```

## 🚨 Устранение неполадок

### Проблемы с подключением
```bash
# Проверка сети Docker
docker network ls
docker network inspect driftnet_driftnet

# Перезапуск сервиса
docker compose restart coordinator
```

### Проблемы с чанками
```bash
# Проверка TTL
docker compose logs | grep TTL

# Проверка маршрутизации
docker compose logs | grep ROUTING
```

## 📊 Производительность

### Рекомендуемые настройки
- **CHUNK_SIZE:** 256000 байт (256 КБ) - оптимальный баланс
- **TTL:** 10000 - длительная циркуляция
- **Количество узлов:** 20 - хорошая избыточность

### Ограничения
- Файлы разбиваются на чанки фиксированного размера
- Чанки циркулируют только в памяти узлов
- Восстановление требует остановки циркуляции

## 🔒 Безопасность

### Текущие ограничения
- Нет шифрования данных
- Нет аутентификации узлов
- Открытые TCP соединения

### Рекомендации
- Использовать только в доверенной сети
- Ограничить доступ к портам узлов
- Мониторить сетевую активность

## 🎯 Преимущества системы

- **Высокая доступность:** Данные циркулируют по всей сети
- **Отказоустойчивость:** Потеря отдельных узлов не критична
- **Масштабируемость:** Легко добавлять новые узлы
- **Автоматическое управление:** Координатор автоматически маршрутизирует трафик
- **Эффективность:** Чанки не хранятся на диске, только в памяти

## 📝 Лицензия

MIT License 