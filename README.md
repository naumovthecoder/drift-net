# DriftNet

DriftNet — это децентрализованная P2P-сеть для передачи файлов по частям (чанкам) между множеством узлов. **Чанки не сохраняются в памяти узлов, а постоянно "гуляют" по сети через стримы.**

Система состоит из нескольких .NET приложений:

- **DriftCoordinator** — координатор сети, регистрирует узлы и выдает список пиров
- **DriftNode** — узел сети, пересылает чанки между узлами через стримы (без сохранения в памяти)
- **DriftUploader** — CLI-утилита для загрузки файла в сеть (разбивает на чанки и отправляет на узлы)
- **DriftGetter** — CLI-утилита для восстановления файла из сети (включает режим перехвата на узлах)

## Как это работает

1. **Координатор** запускается и слушает порт 8000.
2. **20 узлов** запускаются, регистрируются у координатора и слушают свои TCP-порты (5001-5020).
3. **Uploader** разбивает файл на чанки и отправляет их на 5 случайных узлов.
4. **Чанки "гуляют" по сети**:
   - Каждый узел получает чанк и **НЕ сохраняет его в памяти**
   - Узел уменьшает TTL на 1 и пересылает чанк на случайный узел
   - Процесс продолжается, пока TTL > 0
   - **Все передается через стримы без загрузки в оперативку**
5. **Getter** для восстановления:
   - Включает режим перехвата на всех узлах
   - Узлы временно сохраняют проходящие чанки
   - Собирает чанки и восстанавливает файл
   - Выключает режим перехвата

## Ключевые особенности

- **Чанки не хранятся в памяти** - только передаются по стримам
- **Минимальное использование RAM** - данные не загружаются в оперативку
- **TTL ограничивает распространение** - чанк пересылается максимум 30 раз
- **Режим восстановления** - временное перехватывание чанков для сборки файла

---

## Быстрый старт

### 1. Соберите и запустите всю сеть:

```bash
docker-compose up --build -d
```

Это поднимет координатор, 20 узлов, uploader и getter (последние два — в "ожидании").

### 2. Проверьте, что все контейнеры работают:

```bash
docker-compose ps
```

---

## Загрузка файла в сеть

1. Поместите файл для загрузки в корень проекта с именем `testfile.txt` (или измените volume в docker-compose.yml).
2. Запустите загрузку:

```bash
docker-compose run --rm uploader /app/testfile.txt
```

- Файл будет разбит на чанки и отправлен на 5 случайных узлов.
- Чанки начнут "гулять" по сети через стримы.
- В логе увидите, как чанки пересылаются между узлами.

---

## Восстановление файла из сети

1. Запустите восстановление:

```bash
docker-compose run --rm getter chunk- --out /app/output/recovered.txt
```

- Getter включит режим перехвата на всех узлах
- Узлы временно сохранят проходящие чанки
- Файл будет собран из перехваченных чанков
- Режим перехвата будет выключен
- Восстановленный файл появится в папке `output` как `recovered.txt`.

---

## Проверка целостности

Сравните оригинальный и восстановленный файл:

```bash
diff testfile.txt output/recovered.txt
```

Если diff ничего не выводит — файлы идентичны!

---

## Описание сервисов

- **coordinator** — координатор сети (порт 8000)
- **node1 ... node20** — узлы сети (порты 5001-5020) - пересылают чанки через стримы
- **uploader** — CLI для загрузки файла (запускается вручную)
- **getter** — CLI для восстановления файла (запускается вручную)

---

## Полезные команды

- Посмотреть логи координатора:
  ```bash
  docker logs coordinator
  ```
- Посмотреть логи узла:
  ```bash
  docker logs node1
  ```
- Проверить зарегистрированные узлы:
  ```bash
  curl http://localhost:8000/peers
  ```

---

## Примечания

- Все сервисы работают в одной bridge-сети Docker (`driftnet`).
- **Чанки не сохраняются в памяти узлов** - только передаются по стримам
- **Минимальное использование RAM** - идеально для больших файлов
- Если узлы не видны координатору, перезапустите их:
  ```bash
  docker-compose restart node1 node2 node3 ...
  ```
- Для загрузки/выгрузки можно использовать любые файлы, просто меняйте путь в команде.

---

## Автор

- DriftNet — P2P-файловая сеть на .NET + Docker с потоковой передачей данных 